# Zoho CRM Python SDK v8 Implementation (Refactored)

[![Python Version](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)

A robust and field-tested implementation for interacting with the Zoho CRM API v8 using the official `zohocrmsdk` Python package. This project features a refactored structure for better organization and maintainability, incorporating proven methods for authentication, handling common API challenges, and using SDK best practices.

## Overview

This implementation provides a reliable foundation for integrating Python applications with Zoho CRM. It addresses key aspects like authentication using Refresh Tokens, automatic token management via `FileStore`, dynamic Data Center detection, use of the SDK's `Field` class for updates, and fetching records via Custom Views with pagination.

## Key Features

*   **Refactored Project Structure:** Organized into `src/core`, `src/api/leads`, and `src/tests` for clarity and scalability.
*   **Command-Line Interface:** Centralized entry point via `src/cli.py` using `argparse` for running different operations (qualify, update).
*   **Robust Authentication:** Uses the **Refresh Token** flow via a Self Client application for long-term access without repeated manual authorization.
*   **Automatic Token Management:** Leverages the SDK's `FileStore` to automatically handle Access Token generation and renewal, storing tokens securely in the `zoho_data/tokens/` directory.
*   **Dynamic Data Center Detection:** Automatically configures the correct API endpoint based on the `ACCOUNTS_URL` provided in the `.env` file (e.g., .com, .eu, .com.au).
*   **Strongly-Typed Updates:** Uses the SDK's `Field` class (e.g., `Field.Leads.mobile()`) for updating records (`src/api/leads/update.py`), improving type safety and reducing errors.
*   **Mandatory Field Workaround:** Includes a safe update pattern (`src/api/leads/update.py`) that fetches and re-includes potentially required fields to prevent common `MANDATORY_NOT_FOUND` errors.
*   **Lead Qualification via Custom View:** Fetches leads based on a predefined Zoho CRM Custom View (`src/api/leads/qualify.py`), handling pagination correctly and exporting results to a file.
*   **Clear Configuration:** Centralized configuration via a `.env` file.
*   **Structured Logging:** Configured separate application (`logs/app.log`) and SDK internal (`logs/sdk.log`) logs for easier debugging.
*   **Standard SDK:** Uses the official `zohocrmsdk` package.

## Project Structure

```
.env
.env.template
.gitignore
README.md
CHECKLIST.md
zoho_v8_guide.md
requirements.txt  # Recommended: pip freeze > requirements.txt
zoho_data/        # Data storage (should be in .gitignore)
  api_resources/  # For storing SDK resource files (Layouts, etc.)
    resources/    # Generated by SDK
  tokens/         # For storing the SDK's token file
    token_store.txt # Generated by SDK
logs/             # Log files (should be in .gitignore)
  app.log         # Application-level logs
  sdk.log         # SDK internal operational logs
output/           # Output files from commands (should be in .gitignore)
  *.txt           # Example: lead_qualification_results.txt
src/
  __init__.py
  cli.py          # Main command-line interface entry point
  core/
    __init__.py
    initialize.py # Handles SDK initialization, logging, env loading
  api/
    __init__.py
    leads/        # Logic specific to the Leads module
      __init__.py
      common.py   # Shared variables, helpers, constants for leads
      qualify.py  # Functions for lead qualification (using CV)
      update.py   # Functions for updating leads
  tests/
    __init__.py
    test_init.py  # Example test for initialization
    # ... (Other test files would go here)
venv/             # Python virtual environment (should be in .gitignore)
```

## Prerequisites

*   **Python:** Version 3.9 or later recommended.
*   **pip:** Python package installer.
*   **Zoho CRM Account:** An active account with API access enabled.
*   **Zoho API Console Access:** Ability to create and manage applications at [https://api-console.zoho.com](https://api-console.zoho.com).
*   **PowerShell (Windows)** or **`curl` (macOS/Linux):** Required *once* for the initial Grant Token -> Refresh Token exchange.

## Setup

1.  **Clone the Repository:**
    ```bash
    git clone <your-repository-url>
    cd digitalapplied-zoho-v8-sdk # Or your project directory name
    ```

2.  **Create and Activate Virtual Environment:**
    *(Run from the project root directory)*
    ```bash
    # Create environment
    python -m venv venv

    # Activate environment
    # Windows PowerShell:
    .\venv\Scripts\Activate.ps1
    # Windows Command Prompt:
    .\venv\Scripts\activate.bat
    # macOS/Linux (Bash/Zsh):
    source venv/bin/activate
    ```
    Your prompt should now start with `(venv)`.

3.  **Install Dependencies:**
    ```bash
    # Ensure pip is up-to-date
    (venv) python -m pip install --upgrade pip

    # Install required packages
    (venv) pip install zohocrmsdk python-dotenv
    # Consider creating a requirements.txt: pip freeze > requirements.txt
    # Then install using: pip install -r requirements.txt
    ```

## Configuration (Crucial Steps)

This implementation requires a one-time manual process to get a Refresh Token.

1.  **Generate Credentials & Refresh Token:**
    *   Follow **Phase 1 (Steps 1-3)** in the `zoho_v8_guide.md`. This involves:
        *   Registering a **Self Client** application in the Zoho API Console.
        *   Generating a **Grant Token** with the necessary scopes (e.g., `ZohoCRM.modules.ALL,ZohoCRM.settings.ALL,ZohoCRM.users.READ,ZohoCRM.org.READ`).
        *   **Immediately** exchanging the Grant Token for a **Refresh Token** using PowerShell or `curl`.
    *   Securely store the obtained **Client ID**, **Client Secret**, and **Refresh Token**.

2.  **Configure `.env` File:**
    *   Copy the `.env.template` file (if provided) or create a new file named `.env` in the project root.
    *   Edit the `.env` file and fill in your actual credentials and configuration:

        ```dotenv
        # .env file for Zoho CRM SDK Configuration

        # === Zoho Credentials (Required) ===
        # Credentials from the Self Client app (Zoho API Console)
        CLIENT_ID=YOUR_CLIENT_ID_HERE
        CLIENT_SECRET=YOUR_CLIENT_SECRET_HERE
        # REFRESH TOKEN obtained via manual Grant Token exchange
        REFRESH_TOKEN=YOUR_REFRESH_TOKEN_HERE_FROM_STEP_1

        # Your Zoho CRM user email (MUST be an active, confirmed user in the CRM instance)
        USER_EMAIL=your_zoho_login_email@example.com

        # Your Zoho Accounts URL (Determines the Data Center automatically)
        # Examples: https://accounts.zoho.com, https://accounts.zoho.eu, https://accounts.zoho.com.au
        ACCOUNTS_URL=https://accounts.zoho.com

        # === Default Values for CLI Commands (Optional) ===
        # These can be overridden by command-line arguments

        # --- Lead Update Defaults ---
        # Replace with a valid Lead ID from your Zoho CRM instance to use as default for 'update'
        LEAD_ID=YOUR_DEFAULT_LEAD_ID_HERE
        # Replace with the desired default mobile number for the 'update' command
        NEW_MOBILE=YOUR_DEFAULT_MOBILE_HERE

        # --- Lead Qualification Default ---
        # Replace with the ID of the Custom View to use by default for the 'qualify' command
        QUALIFICATION_CUSTOM_VIEW_ID=YOUR_DEFAULT_CUSTOM_VIEW_ID_HERE
        ```
    *   **Important:** Ensure `ACCOUNTS_URL` matches your Zoho account's region (.com, .eu, .in, .com.au, etc.).
    *   Ensure `USER_EMAIL` is the email of an active user within your Zoho CRM organization.
    *   Make sure `.env` is listed in your `.gitignore` file to prevent committing secrets.

## Usage

Ensure your virtual environment is activated and you are in the project root directory (`D:\zoho_v8` or similar) before running commands via the main CLI entry point: `src/cli.py`.

*   **Get Help:**
    ```bash
    python src/cli.py -h
    python src/cli.py qualify -h
    python src/cli.py update -h
    ```

*   **Run Lead Qualification (Using Custom View):**
    Fetches leads from the Custom View specified in `.env` (or via `--cvid`) and saves details to `output/lead_qualification_results.txt`.

    ```bash
    # Use CV ID from .env
    python src/cli.py qualify

    # Specify a different CV ID, overriding .env
    python src/cli.py qualify --cvid 1649349000001234567

    # Specify a different output file
    python src/cli.py qualify --output my_qualified_leads.txt
    ```
    Check the console for progress and the specified output file in the `output/` directory. Detailed logs are in `logs/app.log` and `logs/sdk.log`.

*   **Run Single Lead Update:**
    Updates the 'Mobile' field for a specific lead. Uses values from `.env` by default, or specific values provided via arguments.

    ```bash
    # Update lead ID and mobile number specified in .env
    python src/cli.py update

    # Update a specific lead ID with a specific mobile number
    python src/cli.py update --id 1649349000440877054 --mobile 01238675309

    # Update the lead ID from .env with a specific mobile number
    python src/cli.py update --mobile +15551234567
    ```
    Check the console output for success or failure messages. Verify the change in Zoho CRM.

*   **Run Initialization Test:**
    This simple test verifies that the SDK initializes correctly based on your `.env` configuration and token store.
    ```bash
    python -m src.tests.test_init
    ```
    *(Note: Requires `unittest` which is standard library)*

## Key Implementation Details

*   **Entry Point:** All operations are initiated via `src/cli.py`.
*   **Automatic Initialization:** The SDK is initialized automatically by `src/core/initialize.py` when `src/cli.py` starts (specifically when `src.core.initialize` is first imported). The `Initializer.initialize()` call only runs once per application lifecycle.
*   **Authentication Flow:** Uses `OAuthToken` configured with `client_id`, `client_secret`, and `refresh_token`. Token persistence and automatic refresh are handled by `FileStore` (`zoho_data/tokens/token_store.txt`).
*   **Lead Update (`src/api/leads/update.py`):**
    *   Uses `Field.Leads.mobile()` etc. for setting values.
    *   Implements the mandatory field workaround by fetching fields listed in `UPDATE_REQ_FIELDS` (`common.py`) before updating.
*   **Lead Qualification (`src/api/leads/qualify.py`):**
    *   Uses `RecordOperations(MODULE).get_records()` with the `cvid` parameter.
    *   Handles pagination by creating a new `ParameterMap` for each page request.
    *   Writes results to a file in the `output/` directory.
*   **Configuration (`src/api/leads/common.py` & `.env`):** Constants like `MODULE` name, required fields (`UPDATE_REQ_FIELDS`, `QUALIFY_FIELDS`), and default IDs/values (`TARGET_LEAD_ID_FOR_UPDATE`, `QUALIFICATION_CUSTOM_VIEW_ID`) are managed here, sourcing defaults from the `.env` file.
*   **Data Directory (`zoho_data/`):** Stores persistent SDK information: tokens in `tokens/token_store.txt` and downloaded API resources (metadata) in `api_resources/resources/`. Ensure the application has write permissions here. This directory should typically be excluded from version control.
*   **Logging:** Application-level logs (info, errors in script logic) go to `logs/app.log`. Detailed internal SDK operations (API calls, token refresh) go to `logs/sdk.log`.

## Troubleshooting

*   **`ImportError` / `ModuleNotFoundError`:** Ensure your virtual environment is active. Run scripts from the **project root directory** using `python src/cli.py ...`. Check that all files are present and correctly named.
*   **Initialization Errors:** Check `logs/app.log` first for errors during the initialization phase in `src/core/initialize.py`. Then check `logs/sdk.log` for SDK-specific issues. Common causes:
    *   Incorrect credentials (`CLIENT_ID`, `CLIENT_SECRET`, `REFRESH_TOKEN`) in `.env`.
    *   Invalid or unreachable `ACCOUNTS_URL`.
    *   Network connectivity problems.
    *   File permission errors for `zoho_data/` or `logs/` directories.
*   **`INVALID_TOKEN` / `OAUTH_SCOPE_MISMATCH` (in `sdk.log` or as `APIException`):** Usually means the Refresh Token is invalid/revoked or was generated without the necessary scopes (see Phase 1, Step 2 in the guide). Regenerate the Grant/Refresh tokens with all required scopes.
*   **`MANDATORY_NOT_FOUND` (APIException during Update):** Ensure the `update.py` script fetches and includes all potentially required fields (defined in `UPDATE_REQ_FIELDS` in `common.py`). You might need to add more system-mandatory fields or fields involved in layout rules to this list depending on your specific CRM setup. Verify the API names in the list are correct.
*   **`INVALID_DATA` / `UNABLE_TO_PARSE...` (APIException):** Check the data being sent. For updates, ensure fetched values (like `Lead_Status`, which might be a `Choice` object) are added correctly using `add_field_value`. Ensure field API names used with `Field.Module.field_name()` are correct. Check the specific error `details` in the logs.
*   **Qualify Command Fails:**
    *   Verify `QUALIFICATION_CUSTOM_VIEW_ID` in `.env` (or `--cvid`) is correct and accessible by the API user.
    *   Verify field names in `QUALIFY_FIELDS` (`common.py`) are correct API names for the Leads module.
    *   Check logs for specific API errors.
*   **Attribute Errors on Response (`NoneType` object has no attribute...):** Often indicates an API call failed *before* returning the expected wrapper object (e.g., `ResponseWrapper`, `ActionWrapper`). Check `logs/app.log` and `logs/sdk.log` for the underlying error (often an `APIException` related to authentication, request formation, permissions, or invalid IDs). Ensure `USER_EMAIL` in `.env` is valid and active within the CRM org.

Refer to the **`zoho_v8_guide.md`** (Rev. 5) for more detailed setup and troubleshooting steps.

## License

Specify your license here (e.g., MIT, Apache 2.0) or state if it's private.
Example: `Private - All Rights Reserved.`
```
