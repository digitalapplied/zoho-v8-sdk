# Zoho CRM Python SDK v8 Implementation (Refactored)

[![Python Version](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)

A robust and field-tested implementation for interacting with the Zoho CRM API v8 using the official `zohocrmsdk` Python package. This project features a refactored structure for better organization and maintainability, incorporating proven methods for authentication and handling common API challenges.

## Overview

This implementation provides a reliable foundation for integrating Python applications with Zoho CRM. It addresses key aspects like authentication using Refresh Tokens, automatic token management, dynamic Data Center detection, and workarounds for common API quirks like mandatory field requirements during updates.

## Key Features

*   **Refactored Project Structure:** Organized into `src/core`, `src/api`, and `src/tests` for clarity and scalability.
*   **Robust Authentication:** Uses the **Refresh Token** flow via a Self Client application for long-term access without repeated manual authorization.
*   **Automatic Token Management:** Leverages the SDK's `FileStore` to automatically handle Access Token generation and renewal, storing tokens securely in the `data/tokens/` directory.
*   **Dynamic Data Center Detection:** Automatically configures the correct API endpoint based on the `ACCOUNTS_URL` provided in the `.env` file (e.g., .com, .eu, .com.au).
*   **Mandatory Field Workaround:** Includes a safe update pattern (`src/api/leads.py`) that fetches and re-includes potentially required fields to prevent common `MANDATORY_NOT_FOUND` errors.
*   **Clear Configuration:** Centralized configuration via a `.env` file.
*   **Structured Logging:** Configured logging to `logs/sdk.log` for easier debugging.
*   **Standard SDK:** Uses the official `zohocrmsdk` package.

## Project Structure

```
d:\zoho_v8\
├── .env                # Environment variables (Create from .env.template)
├── .env.template       # Template for environment variables
├── .gitignore          # Git ignore configuration
├── README.md           # This file
├── CHECKLIST.md        # Implementation progress tracking (Optional)
├── zoho_v8_guide.md    # Detailed step-by-step guide (Rev. 4)
├── src/                # Source code package root
│   ├── api/            # Modules for interacting with specific CRM APIs
│   │   ├── __init__.py
│   │   └── leads.py    # Example: Lead operations logic
│   ├── core/           # Core setup, configuration, utilities
│   │   ├── __init__.py
│   │   └── initialize.py # SDK initialization logic
│   ├── tests/          # Unit/Integration tests
│   │   ├── __init__.py
│   │   └── test_init.py # Example: Initialization tests
│   └── __init__.py     # Makes 'src' a package
├── data/               # Data storage (ignored by Git)
│   ├── tokens/         # For storing the SDK's token file
│   │   └── token_store.txt # Generated by SDK
│   └── api_resources/  # For storing SDK resource files (Layouts, etc.)
│       └── resources/  # Generated by SDK within the resource_path
├── logs/               # Log files (ignored by Git)
│   └── sdk.log         # SDK log output configured in initialize.py
└── venv/               # Python virtual environment (ignored by Git)
```

## Prerequisites

*   **Python:** Version 3.9 or later recommended.
*   **pip:** Python package installer.
*   **Zoho CRM Account:** An active account with API access enabled.
*   **Zoho API Console Access:** Ability to create and manage applications at [https://api-console.zoho.com](https://api-console.zoho.com).
*   **PowerShell (Windows)** or **`curl` (macOS/Linux):** Required *once* for the initial Grant Token -> Refresh Token exchange.

## Setup

1.  **Clone the Repository:**
    ```bash
    git clone <your-repository-url>
    cd digitalapplied-zoho-v8-sdk # Or your project directory name
    ```

2.  **Create and Activate Virtual Environment:**
    *(Run from the project root directory)*
    ```bash
    # Create environment
    python -m venv venv

    # Activate environment
    # Windows PowerShell:
    .\venv\Scripts\Activate.ps1
    # Windows Command Prompt:
    .\venv\Scripts\activate.bat
    # macOS/Linux (Bash/Zsh):
    source venv/bin/activate
    ```
    Your prompt should now start with `(venv)`.

3.  **Install Dependencies:**
    ```bash
    # Ensure pip is up-to-date
    (venv) python -m pip install --upgrade pip

    # Install required packages
    (venv) pip install zohocrmsdk python-dotenv
    # Consider creating a requirements.txt: pip freeze > requirements.txt
    # Then install using: pip install -r requirements.txt
    ```

## Configuration (Crucial Steps)

This implementation requires a one-time manual process to get a Refresh Token.

1.  **Generate Credentials & Refresh Token:**
    *   Follow **Phase 1 (Steps 1-3)** in the `zoho_v8_guide.md`. This involves:
        *   Registering a **Self Client** application in the Zoho API Console.
        *   Generating a **Grant Token** with the necessary scopes (e.g., `ZohoCRM.modules.ALL,ZohoCRM.settings.ALL,ZohoCRM.users.READ,ZohoCRM.org.READ`).
        *   **Immediately** exchanging the Grant Token for a **Refresh Token** using PowerShell or `curl`.
    *   Securely store the obtained **Client ID**, **Client Secret**, and **Refresh Token**.

2.  **Configure `.env` File:**
    *   Copy the `.env.template` file to a new file named `.env` in the project root.
    *   Edit the `.env` file and fill in your actual credentials:

        ```dotenv
        # .env file for Zoho CRM SDK Configuration

        # Credentials from the Self Client app (Zoho API Console)
        CLIENT_ID=YOUR_CLIENT_ID_HERE
        CLIENT_SECRET=YOUR_CLIENT_SECRET_HERE

        # REFRESH TOKEN obtained via manual Grant Token exchange
        REFRESH_TOKEN=YOUR_REFRESH_TOKEN_HERE_FROM_STEP_1

        # Your Zoho CRM user email (MUST be an active, confirmed user in the CRM instance)
        USER_EMAIL=your_zoho_login_email@example.com

        # Your Zoho Accounts URL (Determines the Data Center automatically)
        # Examples: https://accounts.zoho.com, https://accounts.zoho.eu, https://accounts.zoho.com.au
        ACCOUNTS_URL=https://accounts.zoho.com

        # --- Variables for the lead update example (src/api/leads.py) ---
        # Replace with a valid Lead ID from your Zoho CRM instance
        LEAD_ID=YOUR_LEAD_ID_HERE
        # Replace with the desired new mobile number for the test
        NEW_MOBILE=YOUR_NEW_MOBILE_NUMBER_HERE
        ```
    *   **Important:** Ensure `ACCOUNTS_URL` matches your Zoho account's region (.com, .eu, .in, .com.au, etc.).
    *   Ensure `USER_EMAIL` is the email of an active user within your Zoho CRM organization.
    *   Make sure `.env` is listed in your `.gitignore` file to prevent committing secrets.

## Usage

Ensure your virtual environment is activated and you are in the project root directory before running commands.

*   **Run Lead Update Example:**
    This script initializes the SDK (if needed) and attempts to update the 'Mobile' field for the `LEAD_ID` specified in your `.env` file, using the mandatory field workaround.

    ```bash
    (venv) python -m src.api.leads
    ```
    Check the console output and verify the change in Zoho CRM. Logs are available in `logs/sdk.log`.

*   **Run Initialization Test:**
    This script verifies that the SDK initializes correctly based on your `.env` configuration.

    ```bash
    (venv) python -m src.tests.test_init
    ```

## Key Implementation Details

*   **Automatic Initialization:** The SDK is initialized automatically when modules like `src.api.leads` or `src.tests.test_init` import from `src.core` (specifically `src.core.initialize`). The `Initializer.initialize()` call only runs once per application lifecycle.
*   **Authentication Flow:** Uses `OAuthToken` configured with the `refresh_token` and `FileStore`. The SDK handles refreshing the access token automatically when it expires.
*   **Mandatory Field Workaround:** The `src.api.leads.py` script demonstrates fetching required fields (`_REQ_FIELDS`) before performing an update. This is often necessary to satisfy Zoho CRM's validation rules, which might require system-mandatory fields or fields involved in layout rules to be present in the update payload, even if they aren't being changed.
*   **Data Directory:** The `data/` directory stores persistent SDK information (`tokens/token_store.txt` and `api_resources/resources/`). Ensure the application has write permissions here. This directory should typically be excluded from version control.

## Troubleshooting

*   **Initialization Errors:** Check `logs/sdk.log` for details. Common causes include incorrect credentials in `.env`, wrong `ACCOUNTS_URL`, network issues, or file permission problems in the `data/` or `logs/` directories.
*   **`INVALID_TOKEN` / `OAUTH_SCOPE_MISMATCH`:** Usually means the Refresh Token is invalid or was generated without the necessary scopes (see Phase 1, Step 2 in the guide). Regenerate the Grant/Refresh tokens with all required scopes.
*   **`MANDATORY_NOT_FOUND`:** Ensure the update script (`src.api.leads.py`) fetches and includes all potentially required fields (defined in `_REQ_FIELDS`). You might need to add more fields to this list depending on your specific CRM setup and layout rules.
*   **Import Errors (`ModuleNotFoundError`):** Make sure the virtual environment is active and you are running scripts from the **project root directory** using the `python -m src.package.module` syntax.
*   **Attribute Errors on Response (`NoneType` object):** Often indicates the API call failed before returning a valid response object. Check `logs/sdk.log` for underlying SDK errors related to authentication, request formation, or permissions. Ensure `USER_EMAIL` in `.env` is valid and active.

Refer to the **`zoho_v8_guide.md`** (Rev. 4) for more detailed setup and troubleshooting steps.

## License

Specify your license here (e.g., MIT, Apache 2.0) or state if it's private.
Example: `Private - All Rights Reserved.`